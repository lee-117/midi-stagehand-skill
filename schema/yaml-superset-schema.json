{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://midscene.dev/yaml-superset-schema.json",
  "title": "Midscene YAML Superset Schema",
  "description": "JSON Schema for validating Midscene YAML files with both native and extended (superset) keywords",
  "type": "object",
  "required": ["tasks"],
  "anyOf": [
    { "required": ["web"] },
    { "required": ["android"] },
    { "required": ["ios"] },
    { "required": ["computer"] }
  ],
  "properties": {
    "web": { "$ref": "#/definitions/webPlatform" },
    "android": { "$ref": "#/definitions/androidPlatform" },
    "ios": { "$ref": "#/definitions/iosPlatform" },
    "computer": { "$ref": "#/definitions/computerPlatform" },
    "agent": { "$ref": "#/definitions/agentConfig" },
    "tasks": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/task" }
    },
    "engine": {
      "type": "string",
      "enum": ["native", "extended"],
      "description": "Processing engine: native (direct execution) or extended (requires transpilation)"
    },
    "features": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "variables", "logic", "loop", "import",
          "data_transform", "try_catch", "external_call", "parallel"
        ]
      },
      "description": "List of extended features used in this file"
    },
    "variables": { "$ref": "#/definitions/variables" },
    "import": {
      "type": "array",
      "items": { "$ref": "#/definitions/importDirective" }
    }
  },
  "additionalProperties": false,
  "definitions": {
    "webPlatform": {
      "type": "object",
      "properties": {
        "url": { "type": "string", "format": "uri-reference" },
        "headless": { "type": "boolean" },
        "viewportWidth": { "type": "integer", "minimum": 1 },
        "viewportHeight": { "type": "integer", "minimum": 1 },
        "userAgent": { "type": "string" },
        "deviceScaleFactor": { "type": "number", "minimum": 0 },
        "cookie": { "type": "string", "description": "Cookie file path" },
        "acceptInsecureCerts": { "type": "boolean" },
        "chromeArgs": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Additional Chrome launch arguments"
        },
        "waitForNetworkIdle": {
          "oneOf": [
            { "type": "boolean" },
            {
              "type": "object",
              "properties": {
                "timeout": { "type": "integer" },
                "continueOnNetworkIdleError": { "type": "boolean" }
              },
              "additionalProperties": false
            }
          ]
        },
        "output": { "type": "string", "description": "JSON output file path" },
        "serve": { "type": "string", "description": "Local static server directory" },
        "bridgeMode": {
          "oneOf": [
            { "const": false },
            { "type": "string", "enum": ["newTabWithUrl", "currentTab"] }
          ]
        },
        "forceSameTabNavigation": { "type": "boolean" },
        "waitForNavigationTimeout": { "type": "integer", "description": "Navigation completion wait time in ms (default 5000, 0 to disable)" },
        "waitForNetworkIdleTimeout": { "type": "integer", "description": "Network idle wait time in ms (default 2000, 0 to disable)" },
        "enableTouchEventsInActionSpace": { "type": "boolean", "description": "Enable touch gestures (default false)" },
        "forceChromeSelectRendering": { "type": "boolean", "description": "Force Chrome base-select styling for <select> elements" },
        "unstableLogContent": {
          "oneOf": [
            { "type": "boolean" },
            { "type": "string" }
          ]
        },
        "closeNewTabsAfterDisconnect": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "androidPlatform": {
      "type": "object",
      "properties": {
        "deviceId": { "type": "string", "description": "ADB device ID (e.g. emulator-5554)" },
        "launch": {
          "oneOf": [
            { "type": "boolean" },
            { "type": "string", "description": "URL or package name to launch" }
          ]
        },
        "output": { "type": "string", "description": "JSON output file path" }
      },
      "additionalProperties": false
    },
    "iosPlatform": {
      "type": "object",
      "properties": {
        "wdaPort": { "type": "integer", "description": "WebDriverAgent port (default 8100)" },
        "wdaHost": { "type": "string", "description": "WebDriverAgent host (default localhost)" },
        "launch": {
          "oneOf": [
            { "type": "boolean" },
            { "type": "string", "description": "URL or bundle ID to launch" }
          ]
        },
        "autoDismissKeyboard": { "type": "boolean" },
        "output": { "type": "string", "description": "JSON output file path" },
        "unstableLogContent": {
          "oneOf": [
            { "type": "boolean" },
            { "type": "string" }
          ]
        }
      },
      "additionalProperties": false
    },
    "computerPlatform": {
      "type": "object",
      "properties": {
        "launch": { "type": "string" },
        "displayId": {
          "oneOf": [
            { "type": "integer" },
            { "type": "string" }
          ]
        },
        "output": { "type": "string", "description": "JSON output file path" }
      },
      "additionalProperties": false
    },
    "agentConfig": {
      "type": "object",
      "properties": {
        "testId": { "type": "string" },
        "groupName": { "type": "string" },
        "groupDescription": { "type": "string" },
        "cache": {
          "oneOf": [
            { "type": "boolean" },
            {
              "type": "object",
              "properties": {
                "strategy": {
                  "type": "string",
                  "enum": ["read-write", "read-only", "write-only"],
                  "description": "Cache strategy"
                },
                "id": { "type": "string", "description": "Cache identifier" }
              },
              "additionalProperties": false
            }
          ]
        },
        "generateReport": { "type": "boolean" },
        "autoPrintReportMsg": { "type": "boolean" },
        "reportFileName": { "type": "string" },
        "replanningCycleLimit": { "type": "integer" },
        "aiActContext": { "type": "string" },
        "waitAfterAction": { "type": "integer", "description": "Milliseconds to wait between actions (default 300)" },
        "outputFormat": { "type": "string", "enum": ["single-html", "html-and-external-assets"], "description": "Report output format" },
        "screenshotShrinkFactor": { "type": "number", "minimum": 1, "description": "Screenshot scaling factor (1-3 recommended)" }
      },
      "additionalProperties": false
    },
    "task": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "flow": {
          "type": "array",
          "items": { "$ref": "#/definitions/flowStep" }
        },
        "steps": {
          "type": "array",
          "items": { "$ref": "#/definitions/flowStep" },
          "description": "Alias for flow"
        },
        "continueOnError": { "type": "boolean" },
        "output": {
          "type": "object",
          "properties": {
            "filePath": { "type": "string", "description": "Output file path for exported data" },
            "dataName": { "type": "string", "description": "Variable name for exported data" }
          },
          "description": "Export task results to a file"
        }
      },
      "additionalProperties": false
    },
    "flowStep": {
      "oneOf": [
        { "$ref": "#/definitions/aiAction" },
        { "$ref": "#/definitions/aiActAction" },
        { "$ref": "#/definitions/aiTapAction" },
        { "$ref": "#/definitions/aiHoverAction" },
        { "$ref": "#/definitions/aiDoubleClickAction" },
        { "$ref": "#/definitions/aiRightClickAction" },
        { "$ref": "#/definitions/aiInputAction" },
        { "$ref": "#/definitions/aiKeyboardPressAction" },
        { "$ref": "#/definitions/aiScrollAction" },
        { "$ref": "#/definitions/aiQueryAction" },
        { "$ref": "#/definitions/aiAskAction" },
        { "$ref": "#/definitions/aiAssertAction" },
        { "$ref": "#/definitions/aiWaitForAction" },
        { "$ref": "#/definitions/sleepAction" },
        { "$ref": "#/definitions/javascriptAction" },
        { "$ref": "#/definitions/recordToReportAction" },
        { "$ref": "#/definitions/runAdbShellAction" },
        { "$ref": "#/definitions/runWdaRequestAction" },
        { "$ref": "#/definitions/launchAction" },
        { "$ref": "#/definitions/variablesStep" },
        { "$ref": "#/definitions/logicStep" },
        { "$ref": "#/definitions/loopStep" },
        { "$ref": "#/definitions/importStep" },
        { "$ref": "#/definitions/dataTransformStep" },
        { "$ref": "#/definitions/tryCatchStep" },
        { "$ref": "#/definitions/externalCallStep" },
        { "$ref": "#/definitions/parallelStep" },
        { "$ref": "#/definitions/useStep" }
      ]
    },
    "aiAction": {
      "type": "object",
      "required": ["ai"],
      "properties": {
        "ai": { "type": "string", "description": "Natural language instruction for the AI to plan and execute" },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "cacheable": { "type": "boolean" },
        "fileChooserAccept": { "oneOf": [{ "type": "string" }, { "type": "array", "items": { "type": "string" } }], "description": "File path(s) for file chooser dialog" },
        "timeout": { "type": "integer" }
      },
      "additionalProperties": false
    },
    "aiActAction": {
      "type": "object",
      "required": ["aiAct"],
      "properties": {
        "aiAct": { "type": "string", "description": "Natural language action instruction" },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "cacheable": { "type": "boolean" },
        "fileChooserAccept": { "oneOf": [{ "type": "string" }, { "type": "array", "items": { "type": "string" } }], "description": "File path(s) for file chooser dialog" },
        "timeout": { "type": "integer" }
      },
      "additionalProperties": false
    },
    "aiTapAction": {
      "type": "object",
      "required": ["aiTap"],
      "properties": {
        "aiTap": {
          "oneOf": [
            { "type": "string", "description": "Element to tap/click" },
            {
              "type": "object",
              "properties": {
                "locator": { "type": "string" },
                "locate": { "$ref": "#/definitions/locateObject" },
                "xpath": { "type": "string" },
                "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] }
              },
              "additionalProperties": false
            }
          ]
        },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "xpath": { "type": "string" },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiHoverAction": {
      "type": "object",
      "required": ["aiHover"],
      "properties": {
        "aiHover": {
          "oneOf": [
            { "type": "string", "description": "Element to hover over" },
            {
              "type": "object",
              "properties": {
                "locator": { "type": "string" },
                "locate": { "$ref": "#/definitions/locateObject" },
                "xpath": { "type": "string" },
                "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] }
              },
              "additionalProperties": false
            }
          ]
        },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "xpath": { "type": "string" },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiDoubleClickAction": {
      "type": "object",
      "required": ["aiDoubleClick"],
      "properties": {
        "aiDoubleClick": {
          "oneOf": [
            { "type": "string", "description": "Element to double-click" },
            {
              "type": "object",
              "properties": {
                "locator": { "type": "string" },
                "locate": { "$ref": "#/definitions/locateObject" },
                "xpath": { "type": "string" },
                "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] }
              },
              "additionalProperties": false
            }
          ]
        },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "xpath": { "type": "string" },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiRightClickAction": {
      "type": "object",
      "required": ["aiRightClick"],
      "properties": {
        "aiRightClick": {
          "oneOf": [
            { "type": "string", "description": "Element to right-click" },
            {
              "type": "object",
              "properties": {
                "locator": { "type": "string" },
                "locate": { "$ref": "#/definitions/locateObject" },
                "xpath": { "type": "string" },
                "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] }
              },
              "additionalProperties": false
            }
          ]
        },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "xpath": { "type": "string" },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiInputAction": {
      "type": "object",
      "required": ["aiInput"],
      "properties": {
        "aiInput": {
          "oneOf": [
            { "type": "string", "description": "Input field to target" },
            {
              "type": "object",
              "properties": {
                "locator": { "type": "string" },
                "locate": { "$ref": "#/definitions/locateObject" },
                "value": { "oneOf": [{ "type": "string" }, { "type": "number" }] },
                "xpath": { "type": "string" },
                "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] }
              },
              "additionalProperties": false
            }
          ]
        },
        "value": { "oneOf": [{ "type": "string" }, { "type": "number" }], "description": "Value to input (flat format)" },
        "mode": { "type": "string", "enum": ["replace", "clear", "typeOnly"], "description": "Input mode" },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "xpath": { "type": "string" },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" },
        "images": { "type": "array", "items": { "type": "object" }, "description": "Image prompts for visual element matching" }
      },
      "additionalProperties": false
    },
    "aiKeyboardPressAction": {
      "type": "object",
      "required": ["aiKeyboardPress"],
      "properties": {
        "aiKeyboardPress": { "type": "string", "description": "Key or key combination to press" },
        "keyName": { "type": "string", "description": "Key name (alternative to aiKeyboardPress value)" },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiScrollAction": {
      "type": "object",
      "required": ["aiScroll"],
      "properties": {
        "aiScroll": {
          "oneOf": [
            { "type": "string", "description": "Target or area to scroll (flat format)" },
            {
              "type": "object",
              "properties": {
                "locator": { "type": "string" },
                "direction": { "type": "string", "enum": ["up", "down", "left", "right"] },
                "distance": { "type": "integer" },

                "scrollType": { "type": "string", "enum": ["singleAction", "scrollToBottom", "scrollToTop", "scrollToRight", "scrollToLeft"] }
              },
              "additionalProperties": false
            }
          ]
        },
        "direction": {
          "type": "string",
          "enum": ["up", "down", "left", "right"],
          "description": "Scroll direction (flat format sibling key)"
        },
        "distance": { "type": "integer", "description": "Scroll distance in pixels (flat format sibling key)" },
        "scrollType": {
          "type": "string",
          "enum": ["singleAction", "scrollToBottom", "scrollToTop", "scrollToRight", "scrollToLeft"],
          "description": "Scroll behavior type (flat format sibling key)"
        },
        "deepThink": { "oneOf": [{ "type": "boolean" }, { "const": "unset" }] },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiQueryAction": {
      "type": "object",
      "required": ["aiQuery"],
      "properties": {
        "aiQuery": {
          "oneOf": [
            { "type": "string", "description": "Data query in natural language" },
            {
              "type": "object",
              "properties": {
                "query": { "type": "string" },
                "name": { "type": "string" }
              },
              "additionalProperties": false
            }
          ]
        },
        "output": { "type": "string", "description": "Variable name to store the query result" },
        "name": { "type": "string" },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiAskAction": {
      "type": "object",
      "required": ["aiAsk"],
      "properties": {
        "aiAsk": {
          "oneOf": [
            { "type": "string", "description": "Question to ask about the page" },
            {
              "type": "object",
              "properties": {
                "query": { "type": "string" },
                "prompt": { "type": "string" },
                "name": { "type": "string" },
                "domIncluded": { "oneOf": [{ "type": "boolean" }, { "const": "visible-only" }] },
                "screenshotIncluded": { "type": "boolean" }
              },
              "additionalProperties": false
            }
          ]
        },
        "name": { "type": "string", "description": "Variable name to store the answer" },
        "domIncluded": { "oneOf": [{ "type": "boolean" }, { "const": "visible-only" }] },
        "screenshotIncluded": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiAssertAction": {
      "type": "object",
      "required": ["aiAssert"],
      "properties": {
        "aiAssert": { "type": "string", "description": "Assertion condition in natural language" },
        "errorMessage": { "type": "string", "description": "Custom error message on assertion failure" },
        "name": { "type": "string", "description": "JSON output key for assertion result" },
        "timeout": { "type": "integer" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "aiWaitForAction": {
      "type": "object",
      "required": ["aiWaitFor"],
      "properties": {
        "aiWaitFor": {
          "oneOf": [
            { "type": "string", "description": "Condition to wait for" },
            {
              "type": "object",
              "properties": {
                "condition": { "type": "string" },
                "timeout": { "type": "integer" }
              },
              "additionalProperties": false
            }
          ]
        },
        "timeout": { "type": "integer" },
        "checkIntervalMs": { "type": "integer", "description": "Interval between checks in ms" },
        "cacheable": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "sleepAction": {
      "type": "object",
      "required": ["sleep"],
      "properties": {
        "sleep": { "type": "integer", "minimum": 0, "description": "Duration to sleep in milliseconds" }
      },
      "additionalProperties": false
    },
    "javascriptAction": {
      "type": "object",
      "required": ["javascript"],
      "properties": {
        "javascript": { "type": "string", "description": "JavaScript code to execute" },
        "output": { "type": "string", "description": "Variable name to store the result" },
        "name": { "type": "string", "description": "Alias for output" }
      },
      "additionalProperties": false
    },
    "recordToReportAction": {
      "type": "object",
      "required": ["recordToReport"],
      "properties": {
        "recordToReport": { "type": "string", "description": "Description or data to record in the report" },
        "content": { "type": "string", "description": "Description text for the report entry" }
      },
      "additionalProperties": false
    },
    "runAdbShellAction": {
      "type": "object",
      "required": ["runAdbShell"],
      "properties": {
        "runAdbShell": { "type": "string", "description": "ADB shell command to execute (Android only)" }
      },
      "additionalProperties": false
    },
    "runWdaRequestAction": {
      "type": "object",
      "required": ["runWdaRequest"],
      "properties": {
        "runWdaRequest": {
          "type": "object",
          "description": "WebDriverAgent request (iOS only)",
          "properties": {
            "method": { "type": "string" },
            "url": { "type": "string" },
            "body": {}
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "launchAction": {
      "type": "object",
      "required": ["launch"],
      "properties": {
        "launch": { "type": "string", "description": "Application to launch" }
      },
      "additionalProperties": false
    },
    "variables": {
      "type": "object",
      "description": "Variable declarations with key-value pairs",
      "additionalProperties": {
        "oneOf": [
          { "type": "string" },
          { "type": "number" },
          { "type": "boolean" },
          { "type": "array" },
          { "type": "object" }
        ]
      }
    },
    "variablesStep": {
      "type": "object",
      "required": ["variables"],
      "properties": {
        "variables": { "$ref": "#/definitions/variables" }
      },
      "additionalProperties": false
    },
    "logicStep": {
      "type": "object",
      "required": ["logic"],
      "properties": {
        "logic": {
          "type": "object",
          "required": ["if", "then"],
          "properties": {
            "if": { "type": "string", "description": "Condition expression to evaluate" },
            "then": {
              "type": "array",
              "items": { "$ref": "#/definitions/flowStep" },
              "description": "Steps to execute if condition is true"
            },
            "else": {
              "type": "array",
              "items": { "$ref": "#/definitions/flowStep" },
              "description": "Steps to execute if condition is false"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "loopStep": {
      "type": "object",
      "required": ["loop"],
      "properties": {
        "loop": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["for", "while", "repeat"],
              "description": "Type of loop"
            },
            "items": {
              "oneOf": [
                { "type": "array" },
                { "type": "string" }
              ],
              "description": "Items to iterate over (for loops)"
            },
            "as": { "type": "string", "description": "Variable name for current item in iteration" },
            "itemVar": { "type": "string", "description": "Alias for as" },
            "item": { "type": "string", "description": "Alias for as" },
            "indexVar": { "type": "string", "description": "Custom index variable name" },
            "condition": { "type": "string", "description": "Loop condition (while loops)" },
            "maxIterations": { "type": "integer", "minimum": 1, "description": "Maximum number of iterations (safety limit)" },
            "max_iterations": { "type": "integer", "minimum": 1, "description": "Alias for maxIterations" },
            "count": {
              "oneOf": [
                { "type": "integer", "minimum": 1 },
                { "type": "string" }
              ],
              "description": "Number of repetitions (repeat loops), supports variable references"
            },
            "times": {
              "oneOf": [
                { "type": "integer", "minimum": 1 },
                { "type": "string" }
              ],
              "description": "Alias for count"
            },
            "flow": {
              "type": "array",
              "items": { "$ref": "#/definitions/flowStep" },
              "description": "Steps to execute in each iteration"
            },
            "steps": {
              "type": "array",
              "items": { "$ref": "#/definitions/flowStep" },
              "description": "Alias for flow"
            }
          }
        }
      },
      "additionalProperties": false
    },
    "importDirective": {
      "type": "object",
      "required": ["import"],
      "properties": {
        "import": { "type": "string", "description": "Path to the YAML file to import" },
        "with": {
          "type": "object",
          "description": "Parameters to pass to the imported file",
          "additionalProperties": true
        },
        "as": { "type": "string", "description": "Alias for the imported module" }
      },
      "additionalProperties": false
    },
    "importStep": {
      "type": "object",
      "required": ["import"],
      "properties": {
        "import": { "type": "string", "description": "Path to the YAML file to import" },
        "with": {
          "type": "object",
          "description": "Parameters to pass to the imported file",
          "additionalProperties": true
        },
        "as": { "type": "string", "description": "Alias for the imported module" }
      },
      "additionalProperties": false
    },
    "dataTransformStep": {
      "type": "object",
      "required": ["data_transform"],
      "properties": {
        "data_transform": {
          "oneOf": [
            {
              "type": "object",
              "required": ["input", "operations"],
              "properties": {
                "input": { "type": "string", "description": "Source variable or expression for transformation" },
                "operations": {
                  "type": "array",
                  "items": { "$ref": "#/definitions/dataOperation" },
                  "description": "Ordered list of transformation operations"
                },
                "output": { "type": "string", "description": "Variable name to store the result" }
              },
              "additionalProperties": false
            },
            {
              "type": "object",
              "required": ["operation", "name"],
              "properties": {
                "source": { "type": "string", "description": "Source variable for transformation" },
                "operation": {
                  "type": "string",
                  "enum": ["filter", "sort", "map", "reduce", "unique", "distinct", "slice", "flatten", "groupBy"],
                  "description": "Transformation operation to apply"
                },
                "name": { "type": "string", "description": "Variable name to store the result" },
                "condition": { "type": "string", "description": "Filter condition (JS expression using item)" },
                "by": { "type": "string", "description": "Field name for sort/unique/groupBy" },
                "field": { "type": "string", "description": "Alias for by" },
                "order": { "type": "string", "enum": ["asc", "desc"], "description": "Sort order" },
                "template": { "description": "Map template object or expression" },
                "reducer": { "type": "string", "description": "Reduce expression (uses acc, item)" },
                "initial": { "description": "Initial value for reduce" },
                "start": { "type": "integer", "description": "Slice start index" },
                "end": { "type": "integer", "description": "Slice end index" },
                "depth": { "type": "integer", "description": "Flatten depth (default 1)" }
              },
              "additionalProperties": false
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "dataOperation": {
      "type": "object",
      "properties": {
        "filter": { "type": "string", "description": "Filter expression" },
        "sort": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "object",
              "properties": {
                "by": { "type": "string" },
                "order": { "type": "string", "enum": ["asc", "desc"] }
              },
              "additionalProperties": false
            }
          ],
          "description": "Sort expression or configuration"
        },
        "map": { "type": "string", "description": "Map/transform expression" },
        "reduce": {
          "type": "object",
          "properties": {
            "reducer": { "type": "string" },
            "initial": {}
          },
          "additionalProperties": false
        },
        "unique": { "type": "string", "description": "Field for deduplication" },
        "distinct": { "type": "string", "description": "Alias for unique" },
        "slice": {
          "type": "object",
          "properties": {
            "start": { "type": "integer" },
            "end": { "type": "integer" }
          },
          "additionalProperties": false
        },
        "flatten": { "type": "integer", "description": "Flatten depth" },
        "groupBy": { "type": "string", "description": "Field to group by" }
      },
      "additionalProperties": false
    },
    "tryCatchStep": {
      "type": "object",
      "required": ["try"],
      "properties": {
        "try": {
          "type": "object",
          "properties": {
            "flow": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } },
            "steps": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } }
          },
          "description": "Steps to attempt (use flow or steps array)"
        },
        "catch": {
          "type": "object",
          "properties": {
            "flow": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } },
            "steps": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } },
            "error": { "type": "string", "description": "Variable name for caught error" },
            "as": { "type": "string", "description": "Alias for error variable name" }
          },
          "description": "Steps to execute if an error occurs"
        },
        "finally": {
          "type": "object",
          "properties": {
            "flow": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } },
            "steps": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } }
          },
          "description": "Steps to always execute regardless of success or failure"
        }
      },
      "additionalProperties": false
    },
    "externalCallStep": {
      "type": "object",
      "required": ["external_call"],
      "properties": {
        "external_call": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["http", "shell"],
              "description": "Call type: http for API requests, shell for system commands"
            },
            "method": {
              "type": "string",
              "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS"],
              "description": "HTTP method (when type is http)"
            },
            "url": { "type": "string", "description": "URL for HTTP requests" },
            "headers": {
              "type": "object",
              "description": "HTTP headers",
              "additionalProperties": { "type": "string" }
            },
            "body": {
              "description": "Request body for HTTP requests",
              "oneOf": [
                { "type": "string" },
                { "type": "object" }
              ]
            },
            "response_as": { "type": "string", "description": "Variable name to store the response" },
            "as": { "type": "string", "description": "Alias for response_as" },
            "name": { "type": "string", "description": "Alias for response_as" },
            "command": { "type": "string", "description": "Shell command to execute (when type is shell)" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "parallelStep": {
      "type": "object",
      "required": ["parallel"],
      "properties": {
        "parallel": {
          "type": "object",
          "properties": {
            "tasks": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "flow": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } },
                  "steps": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } }
                }
              },
              "description": "Array of task branches to execute in parallel"
            },
            "branches": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "flow": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } },
                  "steps": { "type": "array", "items": { "$ref": "#/definitions/flowStep" } }
                }
              },
              "description": "Alias for tasks"
            },
            "waitAll": { "type": "boolean", "description": "Wait for all branches to complete" },
            "merge_results": {
              "oneOf": [
                { "type": "boolean" },
                { "type": "string" }
              ],
              "description": "Merge results from parallel branches"
            }
          },
          "description": "Parallel execution branches"
        }
      },
      "additionalProperties": false
    },
    "useStep": {
      "type": "object",
      "required": ["use"],
      "properties": {
        "use": { "type": "string", "description": "Reference to an imported flow to invoke" },
        "with": {
          "type": "object",
          "description": "Parameters to pass to the invoked flow",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "locateObject": {
      "type": "object",
      "properties": {
        "prompt": { "type": "string" },
        "images": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "url": { "type": "string" }
            },
            "required": ["name", "url"]
          }
        }
      },
      "required": ["prompt"]
    }
  }
}
